from flask import Flask, request, jsonify
import pandas as pd
import os

app = Flask(__name__)

# Load the dataset safely
file_path = os.path.abspath("knowldgegrapg.csv")
try:
    df = pd.read_csv(file_path)
    if df.empty:
        raise ValueError("Dataset is empty")
except Exception as e:
    print(f"Error loading dataset: {e}")
    df = pd.DataFrame(columns=["case_type", "step_number", "step_text"])  # Create an empty dataframe

def get_steps(case_type):
    """Retrieve steps for a given case type."""
    filtered_steps = df[df["case_type"].str.lower() == case_type.lower()].sort_values("step_number")
    return filtered_steps["step_text"].tolist()



@app.route('/get_steps', methods=['POST'])
def get_steps_api():
    data = request.get_json()
    case_type = data.get("query", "").lower().replace("how to do ", "").strip()
    steps = get_steps(case_type)
    
    if not steps:
        return jsonify({"error": "No steps found for this procedure."})
    
    # Generate Mermaid.js flowchart script
    mermaid_code = "graph TD;\n"
    for i in range(len(steps)):
        mermaid_code += f"step{i}[{steps[i]}]" + (" --> " if i < len(steps) - 1 else "") + "\n"
    
    return jsonify({"steps": steps, "mermaid": mermaid_code})

if __name__ == '__main__':
    app.run(debug=True)
